#
# Makefile for the "Falling Down Ball" - game
# Author: Jan Nausner <e01614835@student.tuwien.ac.at>
# 
# Targets:
#   all         generates flash file
#   install     downloads elf file to mcu
#

#TODO write sub makefiles
#TODO make -I, -L and -l generic

FILENAME    = main
MODULES     = adc font game glcd hal_wt41_fc_uart music rand spi timer
ARCHIVES    = mp3 sdcard wiimote
OBJECTS     = $(FILENAME).o
OBJECTS	   += $(MODULES)/$(MODULES).o

MCU         = atmega1280

CCLD        = avr-gcc
CCFLAGS     = -mmcu=$(MCU) -std=gnu99 -Wall -Wextra -Wstrict-prototypes -frename-registers
CCFLAGS	   += -fshort-enums -fpack-struct -I. -Iadc -Ifont -Igame -Iglcd -Ihal_wt41_fc_uart -Imusic -Ilibmp3 -Ilibwiimote -Irand -Ilibsdcard -Ispi -Itimer
LDFLAGS     = -mmcu=$(MCU) -Llibmp3 -Llibsdcard -Llibwiimote -lmp3 -lsdcard -lwiimote

PROG        = avrprog2
PRFLAGS     = -m$(MCU)

all: $(FILENAME).elf

$(FILENAME).elf: $(OBJECTS)
	$(CCLD) -o $@ $(OBJECTS) $(LDFLAGS)

$(FILENAME).o: $(FILENAME).c
	$(CCLD) $(CCFLAGS) -c -o $@ $<

%.o: %.c
	$(MAKE) -C $(patsubst %.o,,$@)

install: $(FILENAME).elf
	$(PROG) $(PRFLAGS) --flash w:$<

verify: $(FILENAME).elf
	$(PROG) $(PRFLAGS) --flash v:$<

clean:
	rm -f $(FILENAME).elf $(OBJECTS)

